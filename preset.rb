# change presets on a THR30ii(w) using osc via sonic pi.
#
# preset handling logic pinched from https://github.com/warmans/go-thr
#
LINE6 = [0x00, 0x01, 0x0c]

UNIV_ALL_DEV_CALL=0x7e

def univ_dev_inq(chan=UNIV_ALL_DEV_CALL)
  midi_sysex 0xf0, chan, 0x7f, 0x06, 0x01, 0xf7
end

def setup
  midi_sysex 0xf0,
    *LINE6,
    0x22, 0x02, 0x4d,
    0x00,
    0x00,
    0x00, 0x00, 0x07,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xF7

  midi_sysex 0xf0,
    *LINE6,
    0x22, 0x02, 0x4d,
    0x00,
    0x01,
    0x00, 0x00, 0x07,
    0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00 , 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xF7

  midi_sysex 0xf0,
    *LINE6,
    0x22, 0x02, 0x4d,
    0x00,
    0x02,
    0x00, 0x00, 0x03,
    0x28, 0x24, 0x6b, 0x09, 0x18, 0x00, 0x00, 0x00,
    0xF7

  midi_sysex 0xf0,
    *LINE6,
    0x22, 0x02, 0x4d,
    0x00,
    0x03,
    0x00, 0x00, 0x03,
    0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xF7
end

def preset(n)
  n = n - 1
  midi_sysex 0xf0,
    *LINE6,
    0x22, 0x02, 0x4d,
    0x01,
    0x00,
    0x00, 0x00, 0x0b,
    0x00, 0x0e, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00,
    n,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0xf7
end

univ_dev_inq
setup

live_loop :osc do
  use_real_time
  print 'waiting for osc'
  path = "/osc:192.168.1.100:9000/1/*"
  a, = sync path
  e = get_event(path).to_s.split(",")[6].strip.tr('"','')
  n = /push([0-9]+)$/.match(e)[1].to_i
  print 'received', a, n
  if a > 0.5 then
    preset(n)
  end
end
